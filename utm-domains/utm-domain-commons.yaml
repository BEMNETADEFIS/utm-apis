### UAS Traffic Management (UTM) API Domain elements

## This document contains definitions, path items, parameters, and responses that 
## are common across APIs. 

## joseph.rios@nasa.gov

definitions:

  scope:
    type: string
    enum:
    - USS_BASIC
    - USS_PUBLICSAFETY
    - FIMS_BASIC
    - FIMS_USSDISCOVERY
  
  # Labels taken from RFC 5424
  severity:
    type: string
    enum:
    - EMERGENCY       # Definitions for
    - ALERT           # these levels
    - CRITICAL        # to be developed
    - WARNING         # together with 
    - NOTICE          # required
    - INFORMATIONAL   # responses.
  
  Operation:
    type: object
    required:
    - gufi
    - registration
    - primary_contact_name
    - primary_contact_phone
    - controller_location
    - operation_volumes
    properties:
      gufi:
        description: "Created and assigned by each USS (not FIMS). Validated as UUID version 4 specification."
        type: string
        format: uuid
        maxLength: 36
        minLength: 36
      submit_time:
        description: >-
          Time the operation submission was received by USS.  Uses the ISO 8601 format conforming to pattern: YYYY-MM-DDThh:mm:ss.sssZ.  Seconds may have up to millisecond accuracy (three positions after decimal).  The 'Z' implies UTC times and is the only timezone accepted.
        type: string
        format: date-time
        minLength: 20
        maxLength: 25
        example: "2015-08-20T14:11:56.118Z"
      decision_time:
        description: >-
          A timestamp set by the USS any time the state of the operation is updated, for example when the flight goes from ACCEPTED to ACTIVATED.  Uses the ISO 8601 format conforming to pattern: YYYY-MM-DDThh:mm:ss.sssZ.  Seconds may have up to millisecond accuracy (three positions after decimal).  The 'Z' implies UTC times and is the only timezone accepted.
        type: string
        format: date-time
        minLength: 20
        maxLength: 25
        example: "2015-08-20T14:11:56.118Z"
      aircraft_comments:
        description: "Informative text about the aircraft. Not used by the UTM System.  Only for human stakeholders."
        type: string
        default: "NOT PROVIDED"
        maxLength: 1000
      flight_comments:
        description: "Informative text about the operation.  Not used by the UTM System.  Only for human stakeholders."
        type: string
        default: "NOT PROVIDED"
        maxLength: 1000
      flight_geography_description:
        description: "Informative text about the operational geography.  Not used by the UTM System.  Only for human stakeholders."
        type: string
        default: "NOT PROVIDED"
        maxLength: 1000
      registration:
        description: "The registration ID of the vehicle flying this operation. This registration value is provided to operators by a vehicle registrar. Validated as a non-null string. Note UTM System assumes a single vehicle per operation."
        type: string
        maxLength: 1000
      registration_source:
        description: "See 'registration' field. This contains the source of the registration ID."
        type: string
        default: "NOT PROVIDED"
        maxLength: 1000
      flight_number:
        description: "Optional. May be useful to the operator or USS for identification purposes."
        type: string
        maxLength: 100
      user_id:
        description: "This field is populated based on the provided credentials."
        type: string
      created_by:
        description: "The user that created the operation."
        type: string
        maxLength: 100
      primary_contact_name:
        description: "Not currently checked for validity, but clients should endeavor to provide useful, appropriate information in these fields. These values should represent the contact that should be used in case of an issue with the operation before, during, or after that operation."
        type: string
        maxLength: 100
      primary_contact_phone:
        type: string
        format: phone
        maxLength: 100
      primary_contact_email:
        type: string
        format: email
        maxLength: 100
      extra_contact_info:
        description: "Any additional contact information that may be useful (hours of availability, fax number, communication limitations, etc.)."
        type: string
        default: "NOT PROVIDED"
        maxLength: 1000
      state:
        description: "The current state of the operation."
        type: string
        enum:
        - ACCEPTED
        - ACTIVATED
        - CLOSED
        - NONCONFORMING
        - ROGUE
        maxLength: 13
        minLength: 5
      controller_location:
        # description: "The planned position of the UAS Controller during the operation. Assumed to be a static location."
        $ref: 'https://api.swaggerhub.com/domains/utm/geojson/v1#/definitions/Point'
      gcs_location:
        # description: "If not submitted, the UTM System will assume the GCS is co-located with the UAS Controller.  Assumed to be a static location."
        $ref: 'https://api.swaggerhub.com/domains/utm/geojson/v1#/definitions/Point'
      faa_rule:
        default: PART_107
        description: |
          PART_107: The operation follows FAA rule 107. If USS notifies FIMS about this class of operations,
          FIMS will reply that authorization is not required. (For TCL2nc FIMS will always accept the operation.)

          PART_107X:  In general, operations are 107X if they are doing something outside the 107 rule that would require
          a waiver under 107.

          PART_101E: This class of operations could be hobbyists being friendly with other users by announcing their intent.
          (For TCL2nc, FIMS will reply with inform message "authorization not required" and accept the operation. For TCL2nc FIMS does not check
          whether the operation is in a preauthorized area.) In the future, a better response for 101E is
          "Notification received" if within 5 statute miles of an airport, and "Notification not required" if not within 5 miles.

          Part_TBD: Placeholder for future rule such as those under test by UTM.

        type: string
        enum:
        - PART_107
        - PART_107X
        - PART_101E
        - PART_TBD
      waiver_certificate_number:
        description: "If a waiver has been obtained for the Part 107 rules, then the operator would have a waiver certificate number. For any operation submissions with faa_rule=PART_107W, this field is required. (likely to be removed in future)"
        type: string
        maxLength: 100
        default: "NOT PROVIDED"
      priority_op:
        type: boolean
        default: false
        description: "If true this operation is managed as a priority operation. Only FIMS or a USS with the public safety role may set this field to true."

      operation_volumes:
        description: "The actual geographical information for the operation.  Maximum array length of 12 currently allowed."
        type: array
        maxLength: 12
        minLength: 1
        items:
          $ref: "#/definitions/OperationVolume"
    example:
      gufi: "00000000-0000-4444-8888-000000000000"
      submit_time: "2016-10-04T09:15:40.727Z"
      decision_time: "2016-10-04T09:15:40.727Z"
      aircraft_comments: "Comments about the aircraft"
      flight_comments: "Comments about the flight"
      flight_geography_description: "A description of the geography"
      registration: "00000000-0000-4444-8888-000000000000"
      registration_detail: "src=federaldroneregistration.com,owner=acme"
      flight_number: "Flight number"
      user_id: "fimsUser"
      created_by: "fimsUser"
      primary_contact_name: "Jane Pilot"
      primary_contact_phone: "XXX-XXX-XXXX"
      primary_contact_email: "pilotjane@janepilot.com"
      extra_contact_info: "Fax: XXX-XXX-XXXX"
      state: A
      controller_location:
        type: Point
        coordinates: [-122.048589,37.414869]
      gcs_location:
        type: Point
        coordinates: [-122.048589,37.414869]
      operation_volumes:
      - ordinal: 1
        near_structure: false
        effective_time_begin: "2017-10-04T09:15:40.727Z"
        effective_time_end: "2017-10-04T09:25:40.727Z"
        actual_time_end: "2017-10-04T09:25:40.727Z"
        conformance_time_begin: "2017-10-04T09:14:40.727Z"
        conformance_time_end: "2017-10-04T09:26:40.727Z"
        min_altitude_wgs84_ft: 0.0
        max_altitude_wgs84_ft: 300.0
        conform_min_altitude_wgs84_ft: 0.0
        conform_max_altitude_wgs84_ft: 400.0
        flight_geography:
          type: Polygon
          coordinates: [
            [
              [-122.062176579,37.40968041145],
              [-122.05187056889,37.41786527236],
              [-122.03732647634,37.41786440108],
              [-122.062176579,37.40968041145],
            ]
          ]
        conformance_geography:
          type: Polygon
          coordinates: [
            [
              [-122.06382530000002,37.40906970000],
              [-122.05094253233000,37.41930062770],
              [-122.03276206976000,37.41929920176],
              [-122.06382530000002,37.40906970000]
            ]
          ]
        beyond_visual_line_of_sight: false

  OperationVolume:
    type: object
    required:
    - ordinal
    - effective_time_begin
    - effective_time_end
    - min_altitude_wgs84_ft
    - max_altitude_wgs84_ft
    - flight_geography
    - beyond_visual_line_of_sight
    properties:
      ordinal:
        description: "This integer represents the ordering of the operation volume within the set of operation volumes. Need not be consecutive integers."
        type: integer
      near_structure:
        description: "Is this operation volume within 400' of a structure?"
        type: boolean
        default: false
      effective_time_begin:
        description: >-
          Earliest time the operation will use the operation volume.  Uses the ISO 8601 format conforming to pattern: YYYY-MM-DDThh:mm:ss.sssZ.  Seconds may have up to millisecond accuracy (three positions after decimal).  The 'Z' implies UTC times and is the only timezone accepted.
        type: string
        format: date-time
        minLength: 20
        maxLength: 25
        example: "2015-08-20T14:11:56.118Z"
      effective_time_end:
        description: >-
          Latest time the operation will done with the operation volume. It must be greater than effective_time_begin.  Uses the ISO 8601 format conforming to pattern: YYYY-MM-DDThh:mm:ss.sssZ.  Seconds may have up to millisecond accuracy (three positions after decimal).  The 'Z' implies UTC times and is the only timezone accepted.
        type: string
        format: date-time
        minLength: 20
        maxLength: 25
        example: "2015-08-20T15:11:56.118Z"
      actual_time_end:
        description: >-
          Time that the operational volume was freed for use by other operations.  Uses the ISO 8601 format conforming to pattern: YYYY-MM-DDThh:mm:ss.sssZ.  Seconds may have up to millisecond accuracy (three positions after decimal).  The 'Z' implies UTC times and is the only timezone accepted.
        type: string
        format: date-time
        minLength: 20
        maxLength: 25
        example: "2015-08-20T14:31:56.118Z"
      conformance_time_begin:
        description: >-
          TO BE DEPRECATED. Assigned by FIMS.  Time buffer before the
          submitted begin time.
        type: string
        maxLength: 100
      conformance_time_end:
        description: >-
          TO BE DEPRECATED. Assigned by FIMS.  Time buffer after the
          submitted end time.
        type: string
        maxLength: 100
      min_altitude_wgs84_ft:
        description: "The minimum altitude for this operation in this operation volume. In WGS84 reference system using feet as units."
        type: number
        format: double
      max_altitude_wgs84_ft:
        description: "The maximum altitude for this operation in this operation volume. In WGS84 reference system using feet as units."
        type: number
        format: double
      conform_min_altitude_wgs84_ft:
        description: >-
          LIKELY TO BE DEPRECATED. The minimum altitude assigned and used by the
          UTM System to check vertical conformance of an operation. Based on
          operator-provided min altitude.
        type: number
        format: double
      conform_max_altitude_wgs84_ft:
        description: >-
          LIKELY TO BE DEPRECATED. The maximum altitude assigned and used by the
          UTM System to check vertical conformance of an operation. Based on
          operator-provided max altitude.
        type: number
        format: double
      flight_geography:
        # description: "A description of the operational area.  This should be the area within which the operation will remain."
        $ref: 'https://api.swaggerhub.com/domains/utm/geojson/v1#/definitions/Geometry'
      conformance_geography:
        # description: "A UTM-generated geography based on the flight geography. See Section 4.4.2 for discussion."
        $ref: 'https://api.swaggerhub.com/domains/utm/geojson/v1#/definitions/Geometry'
      beyond_visual_line_of_sight:
        description: "Describes whether the operation volume is beyond the visual line of sight of the operator."
        type: boolean

  Position:
    type: object
    required:
    - altitude_gps_wgs84_ft
    - altitude_num_gps_satellites
    - gufi
    - hdop_gps
    - location
    - time_measured
    - time_sent
    - track_ground_speed_kn
    - track_true_north_deg
    - vdop_gps
    properties:
      air_speed_source:
        type: string
        description: Required if air_speed_track_kn is submitted. No requirements yet on the values here, but suggestions include ESTIMATED or MEASURED.
        maxLength: 100
      air_speed_track_kn:
        type: number
        format: double
        description: Air speed in relation to the direction of travel of the aircraft.
          Value may be negative.
      altitude_gps_wgs84_ft:
        type: number
        format: double
        description: The altitude as measured via a GPS device on the aircraft. Units
          in feet using the WGS84 reference system.
      altitude_num_gps_satellites:
        type: integer
        format: int32
        description: Number of satellites used in calculating the altitude_gps_wgs84_ft.
        minimum: 0
        exclusiveMinimum: false
      enroute_positions_id:
        type: string
        format: uuid
        description: Each position will be assigned a UUIDv4 by the FIMS
        maxLength: 36
        minLength: 36
      gufi:
        type: string
        format: uuid
        description: Each operation has an GUFI assigned upon submission. Required upon
          POSTing a new position. It is a JSON string, but conforms to the UUID version 4 specification
        maxLength: 36
        minLength: 36
      hdop_gps:
        type: number
        format: double
        description: The horizontal dilution of precision as provided by the onboard
          GPS.
        minimum: 0.0
      location:
        # description: "A description of the 2D location.  A Point geojson ."
        $ref: 'https://api.swaggerhub.com/domains/utm/geojson/v1#/definitions/Point'
      time_measured:
        description: >-
          The time the position was measured. Likely the time provided with the
          GPS position reading.  Time must be before time received at FIMS based
          on FIMS system time.  Uses the ISO 8601 format conforming to pattern: YYYY-MM-DDThh:mm:ss.sssZ.  Seconds may have up to millisecond accuracy (three positions after decimal).  The 'Z' implies UTC times and is the only timezone accepted.
        type: string
        format: date-time
        minLength: 20
        maxLength: 25
        example: "2015-08-20T14:11:56.118Z"
      time_received:
        description: >-
          Not required for submission, assigned by FIMS. The time the position
          was received by FIMS based on FIMS system time.  Uses the ISO 8601 format conforming to pattern: YYYY-MM-DDThh:mm:ss.sssZ.  Seconds may have up to millisecond accuracy (three positions after decimal).  The 'Z' implies UTC times and is the only timezone accepted.
        type: string
        format: date-time
        minLength: 20
        maxLength: 25
        example: "2015-08-20T14:11:57.345Z"
      time_sent:
        description: >-
          The time the position was sent by the USS to FIMS as measured by USS
          system time.  Time must be before time received at FIMS based on FIMS
          system time.  Uses the ISO 8601 format conforming to pattern: YYYY-MM-DDThh:mm:ss.sssZ.  Seconds may have up to millisecond accuracy (three positions after decimal).  The 'Z' implies UTC times and is the only timezone accepted.
        type: string
        format: date-time
        minLength: 20
        maxLength: 25
        example: "2015-08-20T14:11:57.968Z"
      track_ground_speed_kn:
        type: number
        format: double
        description: Ground speed int the direction of travel. Value must be >= 0.0.
          In knots.
        minimum: 0.0
        exclusiveMinimum: false
      track_magnetic_north_deg:
        type: number
        format: double
        description: The direction of travel relative to magnetic north in degrees.
          Value must be >= 0.0 and < 360.0.
        minimum: 0.0
        exclusiveMinimum: false
        maximum: 360.0
        exclusiveMaximum: true
      track_true_north_deg:
        type: number
        format: double
        description: The direction of travel relative to true north in degrees. Value
          must be >= 0.0 and < 360.0.
        minimum: 0.0
        exclusiveMinimum: false
        maximum: 360.0
        exclusiveMaximum: true
      user_id:
        type: string
        description: Not required for submission. This field is populated based on the
          provided credentials in the HTTPS header.
      vdop_gps:
        type: number
        format: double
        description: The vertical dilultion of precision as provided by the onboard
          GPS.
        minimum: 0.0
    example:
      altitude_gps_wgs84_ft: 1111.111
      altitude_num_gps_satellites: 22
      air_speed_source: "MEASURED"
      gufi: "00000000-0000-4444-8888-000000000000"
      hdop_gps: 77.7
      time_measured: "2016-10-04T09:15:40.727Z"
      time_sent: "2016-10-04T09:15:40.727Z"
      time_received: "2016-10-04T09:15:42.727Z"
      track_ground_speed_kn: 33.33
      track_true_north_deg: 235.027287562664
      track_magnetic_north_deg: 237.123456789123
      vdop_gps: 88.8
      location:
        type: "Point"
        coordinates:
        - -122.05635935068132
        - 37.41436490284069
  
  AlertMessage:
    type: object
    description: >-
      An alert message. Used to make other stakeholders aware about an issue with a specific operation.
    properties:
      message_id:
        description: A UUID assigned to this message by the originator
        type: string
        format: uuid
        maxLength: 36
        minLength: 36
      origin:
        description: The user or process that generated this message
        type: string
        enum:
        - FIMS
        - USS
      originator_id:
        description: A name identifying the originator of this message.
        type: string
        maxLength: 100
      gufi:
        description: >-
          The GUFI for the operation referenced in this message.
        type: string
        format: uuid
        maxLength: 36
        minLength: 36
      sent_time:
        description: >-
          Time the message was generated by the origin.  Uses the ISO 8601 format conforming to pattern: YYYY-MM-DDThh:mm:ss.sssZ.  Seconds may have up to millisecond accuracy (three positions after decimal).  The 'Z' implies UTC times and is the only timezone accepted."
        type: string
        format: date-time
        maxLength: 100
        example: "2015-08-20T14:11:57.345Z"
      severity:
        $ref: 'https://api.swaggerhub.com/domains/utm/commons/v1#/definitions/severity'
      text:
        description: >-
          The type of alert message. An enum to constrain messages and allow better interoperability.
        type: string
        enum:
        - UNPLANNED_LANDING
        - UNCONTROLLED_LANDING
        - OPERATION_NON_CONFORMING
        - OPERATION_ROGUE
        - OPERATION_CONFORMING
        - OPERATION_CLOSED
        - OTHER_SEE_FREE_TEXT 
      last_known_position:
        # Last known position of the operation.  The Position model has time incorporated, together with other relevant data.
        $ref: 'https://api.swaggerhub.com/domains/utm/commons/v1#/definitions/Position'
      meta_data:
        type: string
        description: Reserved field.
      free_text:
        description: >-
          Any additional information. Note that this is for human consumption. All time critical elements should be captured in the other data fields for easier consumption by other automated systems.
        type: string
        maxLength: 1000
        
  ConstraintMessage:
    properties:
      message_id:
        description: A UUID assigned to this message by the originator
        type: string
        format: uuid
        maxLength: 36
        minLength: 36
      origin:
        description: The user or process that generated this message
        type: string
        enum:
        - FIMS
        - USS
      originator_id:
        description: A name identifying the originator of this message.
        type: string
        maxLength: 100
      type:
        type: string
        enum:
        - WEATHER
        - ATC
        - SECURITY
        - SAFETY
        - MUNICIPALITY
        - OTHER
      constraint_geography:
        # description: "A description of the geography of the constraint."
        $ref: "https://api.swaggerhub.com/domains/utm/geojson/v1#/definitions/Geometry"
      begin_time:
        description: "The time that the constraint begins. Null or no value implies -infinity begin time."
        type: string
        format: "date-time ending in Z.Eg 2016-04-12T12:35:25Z or 2016-04-12T12:35:25.123Z"
        maxLength: 100
      end_time:
        description: "The time that the constraint ends. Null or no value implies on-going constraint."
        type: string
        format: "date-time ending in Z.Eg 2016-04-12T12:35:25Z or 2016-04-12T12:35:25.123Z"
        maxLength: 100
      min_altitude:
        description: "The minimum altitude of the constraint. Must be less than max_altitude."
        type: number
        format: double
      max_altitude:
        description: "The maximum altitude of the constraint. Must be greater than min_altitude."
        type: number
        format: double
      metadata:
        description: Reserved field.
        type: string
      reason:
        description: "The reason for the constraint. Meant for human consumption."
        type: string
        maxLength: 1000      
  
  NegotiationMessage:
    properties:
      message_id:
        description: A UUID assigned to this message by the originator
        type: string
        format: uuid
        maxLength: 36
        minLength: 36
      origin:
        description: The user or process that generated this message
        type: string
        enum:
        - FIMS
        - USS
      originator_id:
        description: A name identifying the originator of this message.
        type: string
        maxLength: 100
      type:
        type: string
        enum:
        - INTERSECTING_OPERATION_NOTIFICATION
        - INTERSECTING_OPERATION_ACK
        - OTHER
      gufi_of_originator:
        description: >-
          The GUFI of the relevant operation of the originating USS. Note that the origin and receiver roles are strictly dependent on which USS is generating this message.
        type: string
        format: uuid
        maxLength: 36
        minLength: 36
      gufi_of_receiver:
        description: The GUFI of the relevant operation of the receiving USS.
        type: string
        format: uuid
        maxLength: 36
        minLength: 36
      reference_message_id:
        description: >-
          The UUID of a previous message to which this message refers. This field must not be empty when sending a message of type 'INTERSECTING_OPERATION_ACK'.  It must be empty when sending a message of type 'INTERSECTING_OPERATION_NOTIFICATION'.
        type: string
        format: uuid
        maxLength: 36
        minLength: 36
        
  UssInstanceMessage:
    type: object
    description: >-
      A message.
    properties:
      a:
        type: string
        
      
  Version:
    type: object
    properties:
      title:
        type: string
        description: Title of the API
      version: 
        type: string
        description: Version number for the API
      build_time:
        type: string
        description: Time of the latest build 
      api_documentation:
        type: string
        description: URL for API Documentation
      
  UTMRestResponse:
    type: object
    properties: 
      http_status_code: 
        type: integer
      message:
        type: string
      resource:
        type: string
    example:
      http_status_code: 201
      message: "Resource created."
      resource: "/resource/683c0e9e-49dc-44ce-82de-a5723b1f6965"  
      
# responses:
  # GeneralError:
  #   description: General Error
  #   schema:
  #     $ref: '#/definitions/ErrorModel'

parameters:
  fieldsParam:
    name: fields
    in: query
    description: >-
      The specific subset of fields to return. Comma separated list. Default will be all fields when this parameter is not provided in the query. Duplicate field names not allowed and server may reject query if duplicates are provided. If field names are provided that are not part of the request model, the server may either reject the query or ignore the improper fields. Maximum 20 field values supported. If more than 20 fields are required, then this parameter should not be used so that all fields are returned.
    required: false
    type: array
    items:
      type: string
    collectionFormat: csv
    maxItems: 20
    minItems: 1
    uniqueItems: true
  sortParam:
    name: sort
    in: query
    description: >-
      A valid field name to use for sorting records. If multiple fields are provided, the sorting is based on the ordered priorty of that list.
    required: false
    default: time_submitted
    type: string
  sortIncreasingParam:
    name: sort_increasing
    in: query
    description: >-
      For optional use with the 'sort' parameter. If 'sort' is not provided, then 'sort_increasing' will be ignored. Boolean value.  If multiple fields are provided in the 'sort' paramenter, this boolean value will apply to all of them.
    required: false
    default: true
    type: boolean
  limitParam:
      name: limit
      in: query
      description: The maximum number or records to return.
      required: false
      type: integer
      default: 10
      format: int32
      maximum: 100
      minimum: 1
  offsetParam:
      name: offset
      in: query
      description: The index from which to begin the list of returned records.
      required: false
      type: integer
      default: 0
      format: int32